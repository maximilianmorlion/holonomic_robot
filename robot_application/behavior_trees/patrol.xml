<root main_tree_to_execute="PatrolMission">
  <BehaviorTree ID="PatrolMission">
    <Sequence name="patrol_sequence">
      
      <!-- Initialize mission -->
      <Action ID="LoadWaypoints" 
              name="load_waypoints"
              waypoints_file="{waypoints_file}"/>
      
      <!-- Main patrol loop -->
      <RepeatUntilFailure num_cycles="{num_cycles}" name="patrol_loop">
        <Sequence name="patrol_cycle">
          
          <!-- Iterate through waypoints -->
          <ForEachLoop name="waypoint_iterator">
            <Sequence name="waypoint_sequence">
              
              <!-- Navigate to waypoint -->
              <RetryUntilSuccessful num_attempts="3" name="nav_retry">
                <Sequence name="navigation">
                  
                  <!-- Check localization quality -->
                  <Condition ID="CheckLocalization" 
                             name="check_loc"
                             min_confidence="0.7"/>
                  
                  <!-- Navigate to target -->
                  <Action ID="NavigateToWaypoint" 
                          name="nav_to_waypoint"
                          waypoint="{current_waypoint}"
                          timeout="120.0"/>
                  
                  <!-- Verify arrival -->
                  <Condition ID="IsAtPosition" 
                             name="verify_arrival"
                             position="{current_waypoint}"
                             tolerance="0.2"/>
                </Sequence>
              </RetryUntilSuccessful>
              
              <!-- Pause at waypoint -->
              <Action ID="Wait" 
                      name="pause_at_waypoint"
                      duration="{pause_duration}"/>
              
            </Sequence>
          </ForEachLoop>
          
          <!-- Log cycle completion -->
          <Action ID="LogInfo" 
                  name="log_cycle_complete"
                  message="Patrol cycle completed"/>
          
        </Sequence>
      </RepeatUntilFailure>
      
      <!-- Mission complete -->
      <Action ID="LogInfo" 
              name="log_mission_complete"
              message="Patrol mission completed"/>
      
    </Sequence>
  </BehaviorTree>
  
  <!-- Recovery behavior tree -->
  <BehaviorTree ID="RecoveryBehavior">
    <Sequence name="recovery_sequence">
      
      <!-- Stop current motion -->
      <Action ID="StopRobot" name="stop_robot"/>
      
      <!-- Try recovery strategies -->
      <Fallback name="recovery_strategies">
        
        <!-- Strategy 1: Rotate to improve localization -->
        <Sequence name="rotate_recovery">
          <Action ID="LogInfo" 
                  name="log_rotate"
                  message="Recovery: Rotating for localization"/>
          <Action ID="RotateInPlace" 
                  name="rotate_360"
                  angle="6.28"
                  speed="0.3"/>
        </Sequence>
        
        <!-- Strategy 2: Clear costmaps and retry -->
        <Sequence name="costmap_recovery">
          <Action ID="LogInfo" 
                  name="log_clear_costmap"
                  message="Recovery: Clearing costmaps"/>
          <Action ID="ClearCostmaps" name="clear_costmaps"/>
          <Action ID="Wait" 
                  name="wait_after_clear"
                  duration="2.0"/>
        </Sequence>
        
        <!-- Strategy 3: Back up and retry -->
        <Sequence name="backup_recovery">
          <Action ID="LogInfo" 
                  name="log_backup"
                  message="Recovery: Backing up"/>
          <Action ID="BackUp" 
                  name="backup"
                  distance="0.5"
                  speed="0.2"/>
        </Sequence>
        
      </Fallback>
      
    </Sequence>
  </BehaviorTree>
  
</root>
