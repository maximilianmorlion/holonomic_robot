<root main_tree_to_execute="PickPlaceMission">
  <BehaviorTree ID="PickPlaceMission">
    <Sequence name="pick_place_sequence">
      
      <!-- Initialize mission -->
      <Action ID="LoadTasks" 
              name="load_tasks"
              tasks_file="{tasks_file}"/>
      
      <!-- Iterate through tasks -->
      <ForEachLoop name="task_iterator">
        <Sequence name="task_sequence">
          
          <!-- Phase 1: Navigate to pickup location -->
          <Sequence name="navigate_to_pickup">
            <Action ID="LogInfo" 
                    name="log_nav_pickup"
                    message="Navigating to pickup location"/>
            
            <RetryUntilSuccessful num_attempts="3" name="nav_pickup_retry">
              <Action ID="NavigateToWaypoint" 
                      name="nav_to_pickup"
                      waypoint="{pickup_location}"
                      timeout="120.0"/>
            </RetryUntilSuccessful>
          </Sequence>
          
          <!-- Phase 2: Approach object -->
          <Sequence name="approach_object">
            <Action ID="LogInfo" 
                    name="log_approach"
                    message="Approaching object"/>
            
            <Action ID="ApproachTarget" 
                    name="approach"
                    distance="{approach_distance}"/>
          </Sequence>
          
          <!-- Phase 3: Pick up object -->
          <Fallback name="pickup_method">
            
            <!-- Vacuum pickup -->
            <Sequence name="vacuum_pickup">
              <Condition ID="IsPickupMethod" 
                         name="check_vacuum"
                         method="vacuum"/>
              
              <Action ID="LogInfo" 
                      name="log_vacuum"
                      message="Activating vacuum"/>
              
              <Action ID="ActivatePump" 
                      name="vacuum_on"
                      pump_id="0"
                      duty_cycle="0.8"
                      duration="{pickup_duration}"/>
              
              <!-- Verify pickup -->
              <Condition ID="IsPressureOK" 
                         name="check_vacuum_pressure"
                         min_pressure="50000.0"/>
            </Sequence>
            
            <!-- Gripper pickup -->
            <Sequence name="gripper_pickup">
              <Condition ID="IsPickupMethod" 
                         name="check_gripper"
                         method="gripper"/>
              
              <Action ID="LogInfo" 
                      name="log_gripper"
                      message="Using gripper"/>
              
              <!-- Lower gripper -->
              <Action ID="MoveServoAction" 
                      name="lower_gripper"
                      servo_id="1"
                      angle="90.0"
                      speed="30.0"/>
              
              <Action ID="Wait" 
                      name="wait_lower"
                      duration="0.5"/>
              
              <!-- Close gripper -->
              <Action ID="MoveServoAction" 
                      name="close_gripper"
                      servo_id="0"
                      angle="45.0"
                      speed="20.0"/>
              
              <Action ID="Wait" 
                      name="wait_close"
                      duration="0.5"/>
              
              <!-- Raise gripper -->
              <Action ID="MoveServoAction" 
                      name="raise_gripper"
                      servo_id="1"
                      angle="0.0"
                      speed="30.0"/>
              
              <!-- Verify grip -->
              <Condition ID="IsGripForceOK" 
                         name="check_grip_force"
                         min_force="1.0"/>
            </Sequence>
            
          </Fallback>
          
          <!-- Phase 4: Navigate to place location -->
          <Sequence name="navigate_to_place">
            <Action ID="LogInfo" 
                    name="log_nav_place"
                    message="Navigating to place location"/>
            
            <RetryUntilSuccessful num_attempts="3" name="nav_place_retry">
              <Action ID="NavigateToWaypoint" 
                      name="nav_to_place"
                      waypoint="{place_location}"
                      timeout="120.0"/>
            </RetryUntilSuccessful>
          </Sequence>
          
          <!-- Phase 5: Release object -->
          <Fallback name="release_method">
            
            <!-- Vacuum release -->
            <Sequence name="vacuum_release">
              <Condition ID="IsPickupMethod" 
                         name="check_vacuum_release"
                         method="vacuum"/>
              
              <Action ID="LogInfo" 
                      name="log_vacuum_off"
                      message="Deactivating vacuum"/>
              
              <Action ID="ActivatePump" 
                      name="vacuum_off"
                      pump_id="0"
                      duty_cycle="0.0"
                      duration="0.0"/>
            </Sequence>
            
            <!-- Gripper release -->
            <Sequence name="gripper_release">
              <Condition ID="IsPickupMethod" 
                         name="check_gripper_release"
                         method="gripper"/>
              
              <Action ID="LogInfo" 
                      name="log_gripper_open"
                      message="Opening gripper"/>
              
              <!-- Lower gripper -->
              <Action ID="MoveServoAction" 
                      name="lower_gripper_place"
                      servo_id="1"
                      angle="90.0"
                      speed="30.0"/>
              
              <Action ID="Wait" 
                      name="wait_lower_place"
                      duration="0.5"/>
              
              <!-- Open gripper -->
              <Action ID="MoveServoAction" 
                      name="open_gripper"
                      servo_id="0"
                      angle="0.0"
                      speed="20.0"/>
              
              <Action ID="Wait" 
                      name="wait_open"
                      duration="0.5"/>
              
              <!-- Raise gripper -->
              <Action ID="MoveServoAction" 
                      name="raise_gripper_place"
                      servo_id="1"
                      angle="0.0"
                      speed="30.0"/>
            </Sequence>
            
          </Fallback>
          
          <!-- Phase 6: Retreat to safe position -->
          <Sequence name="retreat">
            <Action ID="LogInfo" 
                    name="log_retreat"
                    message="Retreating to safe position"/>
            
            <Action ID="BackUp" 
                    name="backup_after_place"
                    distance="{approach_distance}"
                    speed="0.2"/>
          </Sequence>
          
          <!-- Log task completion -->
          <Action ID="LogInfo" 
                  name="log_task_complete"
                  message="Task {task_name} completed"/>
          
        </Sequence>
      </ForEachLoop>
      
      <!-- Mission complete -->
      <Action ID="LogInfo" 
              name="log_mission_complete"
              message="All pick-place tasks completed"/>
      
    </Sequence>
  </BehaviorTree>
</root>
