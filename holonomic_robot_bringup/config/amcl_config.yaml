amcl:
  ros__parameters:
    use_sim_time: false
    robot_model_type: "nav2_amcl::OmniMotionModel"

    # Initial pose - bottom left of L-shaped room
    set_initial_pose: True  # Enable to initialize AMCL with known pose (triggers TF broadcast)
    initial_pose:
      x: 0.3
      y: 0.2
      z: 0.0
      yaw: 0.0
    
    # Frame IDs
    global_frame_id: map
    odom_frame_id: odom
    base_frame_id: base_footprint
    scan_topic: scan
    
    # Transform settings - allow AMCL to correct drift smoothly
    transform_tolerance: 0.5
    tf_broadcast: true
    
    # More particles for better localization accuracy
    min_particles: 500
    max_particles: 2000
    
    # Frequent updates to catch and correct drift quickly
    update_min_d: 0.0001   # Update with tiny movement (triggers on odom jitter)
    update_min_a: 0.0001  # Update with tiny rotation
    resample_interval: 1  # Resample every update
    
    # Particle filter settings - balance between convergence and tracking
    pf_err: 0.01  # Looser for faster convergence
    pf_z: 0.99    # More aggressive resampling
    
    # Laser model - trust laser readings highly
    laser_max_range: 12.0
    laser_min_range: 0.0
    laser_max_beams: 6000        # Use more beams for accuracy
    laser_model_type: likelihood_field
    laser_likelihood_max_dist: 0.5
    laser_z_hit: 0.98             # Very high weight on correct measurements
    laser_z_short: 0.01            # Very low weight on short readings
    laser_z_max: 0.005             # Very low weight on max range readings
    laser_z_rand: 0.005            # Minimal random noise
    laser_sigma_hit: 0.02          # Very tight sensor model for fast convergence
    laser_lambda_short: 0.1
    
    # Odometry model - Optical flow (accurate linear) + gyro (slow drift, low noise)
    odom_model_type: omni
    odom_alpha1: 0.002  # Low noise - gyro is fairly accurate short-term
    odom_alpha2: 0.002  # Low noise - rotation doesn't affect translation much
    odom_alpha3: 0.002  # Low noise - optical flow is accurate for translation
    odom_alpha4: 0.005  # Slightly higher - rotation affects heading integration
    odom_alpha5: 0.002  # Low noise - optical flow measures strafe well
    
    # Recovery settings - enable to handle kidnapped robot
    recovery_alpha_slow: 0.0      # Disable slow recovery (we want fast correction)
    recovery_alpha_fast: 0.0      # Disable fast recovery
    do_beamskip: false            # Don't skip beams
    beam_skip_distance: 0.5
    beam_skip_threshold: 0.3
    beam_skip_error_threshold: 0.9
    
    # Initial uncertainty - tight (we know roughly where we start)
    initial_pose_x: 0.3
    initial_pose_y: 0.2
    initial_pose_a: 0.0
    initial_cov_xx: 0.02  # Tighter initial x uncertainty (was 0.05)
    initial_cov_yy: 0.02  # Tighter initial y uncertainty (was 0.05)
    initial_cov_aa: 0.02  # Tighter initial yaw uncertainty (was 0.05)
    
    # Pose publishing
    save_pose_rate: 10.0  # Save pose frequently
    always_reset_initial_pose: true  # Allow RViz Set Initial Pose to override
    first_map_only: false
    
    # KLD sampling for adaptive particle count
    kld_err: 0.05
    kld_z: 0.99
    
    # Spatial resampling
    spatial_resample_threshold: 0.2
    
    # Global localization
    global_localization: false  # Disabled to prevent jumping
    
    # Maximum number of beams to use
    max_beams: 360
    
    # Minimum and maximum particle weights
    alpha_slow: 0.0
    alpha_fast: 0.0

        # Force position updates by ignoring odometry confidence
    sigma_hit: 0.2
    
    # Increase selectivity
    selective_resampling: false